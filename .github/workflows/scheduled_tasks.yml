name: Calorista Daily Tasks

on:
  schedule:
    - cron: '0 1 * * *'  # 1 AM UTC (3 AM Kyiv)
  workflow_dispatch:

jobs:
  daily-tasks:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'
          
      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          pip install -r calorista/requirements.txt
          pip install flask redis pandas python-dotenv plotly
          echo "‚úÖ Dependencies installed"
          
      - name: Setup environment
        run: |
          echo "üïí Timezone: $(TZ='Europe/Kiev' date)"
          echo "üêç Python version: $(python --version)"
          echo "üìÅ Working directory: $(pwd)"
          echo "üîç Installed packages:"
          pip list
          echo "::notice::Environment setup complete"
          
      - name: Verify Redis connection
        run: |
          echo "üîç Testing Redis connection..."
          python -c "
          import os, redis
          from urllib.parse import urlparse
          url = os.getenv('REDIS_URL')
          if not url:
              raise ValueError('REDIS_URL environment variable not set')
          parsed = urlparse(url)
          print(f'Connecting to Redis at {parsed.hostname}:{parsed.port or 6379}')
          r = redis.Redis.from_url(url, socket_connect_timeout=5)
          try:
              ping_response = r.ping()
              print(f'‚úÖ Redis ping successful: {ping_response}')
          except Exception as e:
              print(f'‚ùå Redis connection failed: {str(e)}')
              raise
          "
        env:
          REDIS_URL: redis://default:${{ secrets.UPSTASH_REST_TOKEN }}@gentle-eagle-30096.upstash.io:6379
          
      - name: Run main script
        run: |
          echo "üöÄ Starting main.py..."
          set +e
          python calorista/main.py 2>&1 | tee main.log
          MAIN_EXIT_CODE=${PIPESTATUS[0]}
          echo "::group::Main script output"
          cat main.log
          echo "::endgroup::"
          if [ $MAIN_EXIT_CODE -ne 0 ]; then
            echo "::error::Main script failed with exit code $MAIN_EXIT_CODE"
            exit $MAIN_EXIT_CODE
          fi
        env:
          REDIS_URL: redis://default:${{ secrets.UPSTASH_REST_TOKEN }}@gentle-eagle-30096.upstash.io:6379
          TZ: 'Europe/Kiev'
          
      - name: Run historical loader
        run: |
          echo "üîÑ Starting historical loader..."
          set +e
          python calorista/load_historical_to_redis.py 2>&1 | tee loader.log
          LOADER_EXIT_CODE=${PIPESTATUS[0]}
          echo "::group::Loader output"
          cat loader.log
          echo "::endgroup::"
          if [ $LOADER_EXIT_CODE -ne 0 ]; then
            echo "::error::Historical loader failed with exit code $LOADER_EXIT_CODE"
            exit $LOADER_EXIT_CODE
          fi
        env:
          REDIS_URL: redis://default:${{ secrets.UPSTASH_REST_TOKEN }}@gentle-eagle-30096.upstash.io:6379
          TZ: 'Europe/Kiev'
          
      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: execution-logs
          path: |
            main.log
            loader.log
          retention-days: 3
          
      - name: Completion status
        if: always()
        run: |
          if grep -q "Traceback" main.log loader.log || grep -q "Error" main.log loader.log; then
            echo "::error title=Failed::‚ùå Some tasks failed (check logs)"
            exit 1
          else
            echo "::notice title=Success::‚úÖ All tasks completed successfully!"
          fi
          echo "üìä View run details: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
