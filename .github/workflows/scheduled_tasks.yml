name: Calorista Daily Tasks

on:
  schedule:
    - cron: '0 1 * * *'  # 1 AM UTC daily (3 AM Kyiv time)
  workflow_dispatch:

jobs:
  daily-tasks:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.13'
          
      - name: Install dependencies
        run: |
          echo "üì¶ Installing dependencies..."
          pip install -r calorista/requirements.txt
          
      - name: Setup environment
        run: |
          echo "üïí Timezone: $(date)"
          echo "üêç Python version: $(python --version)"
          echo "üìÅ Working directory: $(pwd)"
          echo "::notice::Environment setup complete"
          
      - name: Run main script
        run: |
          echo "üöÄ Starting main.py..."
          python calorista/main.py 2>&1 | tee -a main.log
          echo "::group::Main script output"
          cat main.log
          echo "::endgroup::"
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}  # This is correct syntax
          TZ: 'Europe/Kiev'
          
      - name: Run historical loader
        run: |
          echo "üîÑ Starting historical loader..."
          python calorista/load_historical_to_redis.py 2>&1 | tee -a loader.log
          echo "::group::Loader output"
          cat loader.log
          echo "::endgroup::"
        env:
          REDIS_URL: ${{ secrets.REDIS_URL }}  # Correct syntax
          
      - name: Archive logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: execution-logs
          path: |
            *.log
          
      - name: Completion status
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "::notice title=Success::‚úÖ All tasks completed successfully!"
          else
            echo "::error title=Failed::‚ùå Some tasks failed"
          fi
          echo "üìä View run details: $GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"